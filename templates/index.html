<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NAVER Vietnam AI Hackathon - Email Sender</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            color: #2c3e50;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: linear-gradient(135deg, #00aaaa 0%, #00cccc 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 170, 170, 0.3);
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 700;
        }
        
        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            border: 1px solid #e0e0e0;
        }
        
        .card h2 {
            color: #00aaaa;
            margin-bottom: 20px;
            font-size: 1.5em;
            font-weight: 600;
        }
        
        .upload-section {
            text-align: center;
        }
        
        .upload-description {
            color: #666;
            margin-bottom: 20px;
            font-size: 0.9em;
        }
        
        .file-upload-area {
            margin: 20px 0;
        }
        
        .file-input-wrapper {
            position: relative;
            display: block;
            margin: 0 auto;
            max-width: 400px;
        }
        
        .file-input {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        
        .file-upload-box {
            border: 2px dashed #ddd;
            border-radius: 10px;
            padding: 40px 20px;
            text-align: center;
            background: #fafafa;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .file-upload-box:hover {
            border-color: #00aaaa;
            background: #f0f8ff;
        }
        
        .upload-icon {
            font-size: 3em;
            margin-bottom: 15px;
        }
        
        .upload-text {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .upload-text strong {
            color: #333;
            font-size: 1.1em;
        }
        
        .upload-text span {
            color: #666;
            font-size: 0.9em;
        }
        
        .file-name {
            margin-top: 15px;
            color: #00aaaa;
            font-weight: 500;
            font-size: 0.9em;
        }
        
        .upload-btn {
            margin-top: 20px;
            padding: 12px 30px;
            font-size: 1.1em;
        }
        
        .control-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }
        
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 25px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #00aaaa 0%, #00cccc 100%);
            color: white;
            box-shadow: 0 5px 15px rgba(0, 170, 170, 0.3);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 170, 170, 0.4);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.3);
        }
        
        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(231, 76, 60, 0.4);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            color: white;
            box-shadow: 0 5px 15px rgba(39, 174, 96, 0.3);
        }
        
        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(39, 174, 96, 0.4);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }
        
        .status-section {
            grid-column: 1 / -1;
        }
        
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .status-item {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            border-left: 4px solid #00aaaa;
        }
        
        .status-item h3 {
            color: #00aaaa;
            font-size: 2em;
            margin-bottom: 5px;
        }
        
        .status-item p {
            color: #666;
            font-size: 0.9em;
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            margin: 20px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #00aaaa, #00cccc);
            border-radius: 10px;
            transition: width 0.3s ease;
            width: 0%;
        }
        
        .logs-section {
            background: #2c3e50;
            color: #ecf0f1;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #4a5f7a;
            min-height: 200px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.4;
        }
        
        .logs-section h3 {
            color: #00aaaa;
            margin-bottom: 15px;
        }
        
        .log-entry {
            padding: 8px 0;
            border-bottom: 1px solid #34495e;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }
        
        .log-entry.success {
            color: #2ecc71;
            font-weight: 500;
        }
        
        .log-entry.error {
            color: #e74c3c;
            font-weight: 500;
        }
        
        /* Status text styling */
        .status-ready {
            color: #27ae60;
            font-weight: bold;
        }
        
        .status-sending {
            color: #f39c12;
            font-weight: bold;
            animation: pulse 1.5s infinite;
        }
        
        .status-completed {
            color: #27ae60;
            font-weight: bold;
        }
        
        .status-completed-with-errors {
            color: #e67e22;
            font-weight: bold;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        
        .log-entry.info {
            color: #3498db;
        }
        
        .log-entry.warning {
            color: #f39c12;
            font-weight: 500;
        }
        
        .alert {
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            font-weight: 500;
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #00aaaa;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .hidden {
            display: none;
        }
        
        /* Template Selection Styles */
        .template-selection {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .template-option {
            position: relative;
        }
        
        .template-option input[type="radio"] {
            position: absolute;
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .template-label {
            display: block;
            cursor: pointer;
            border: 2px solid #ddd;
            border-radius: 10px;
            padding: 20px;
            transition: all 0.3s ease;
            background: white;
        }
        
        .template-label:hover {
            border-color: #00aaaa;
            background: #f8f9fa;
        }
        
        .template-option input[type="radio"]:checked + .template-label {
            border-color: #00aaaa;
            background: #f0f8ff;
            box-shadow: 0 0 0 2px rgba(0, 170, 170, 0.2);
        }
        
        .template-preview h3 {
            color: #00aaaa;
            margin: 0 0 10px 0;
            font-size: 1.2em;
        }
        
        .template-preview p {
            margin: 5px 0;
            color: #666;
            font-size: 0.9em;
        }
        
        .template-preview strong {
            color: #333;
        }
        
        .template-section {
            grid-column: 1 / -1;
        }
        
        .template-description {
            color: #666;
            margin-bottom: 20px;
            font-size: 0.9em;
            text-align: center;
        }
        
        .control-section {
            grid-column: 1 / -1;
        }
        
        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .control-buttons {
                flex-direction: column;
            }
            
            .status-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .template-selection {
                gap: 10px;
            }
            
            .template-label {
                padding: 15px;
            }
            
            .file-upload-box {
                padding: 30px 15px;
            }
            
            .upload-icon {
                font-size: 2.5em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>NAVER Vietnam AI Hackathon</h1>
            <p>Email Sender System</p>
        </div>
        
        <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ 'error' if category == 'error' else 'success' }}">
                        {{ message }}
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}
        
        <div class="main-content">
            <!-- Upload Section -->
            <div class="card upload-section">
                <h2>Upload CSV File</h2>
                <p class="upload-description">Upload a CSV file containing participant information (name, email)</p>
                <form id="uploadForm" method="POST" action="/upload" enctype="multipart/form-data">
                    <div class="file-upload-area">
                        <div class="file-input-wrapper">
                            <input type="file" id="csvFile" name="csv_file" accept=".csv" class="file-input" required>
                            <div class="file-upload-box">
                                <div class="upload-icon">📄</div>
                                <div class="upload-text">
                                    <strong>Click to choose CSV file</strong>
                                    <span>or drag and drop here</span>
                                </div>
                            </div>
                        </div>
                        <div class="file-name" id="fileName"></div>
                    </div>
                    <button type="submit" class="btn btn-primary upload-btn" id="uploadBtn">
                        Upload File
                    </button>
                </form>
            </div>
            
            <!-- Template Selection Section -->
            <div class="card template-section">
                <h2>📧 Select Email Template</h2>
                <p class="template-description">Choose the appropriate email template for your campaign</p>
                <div class="template-selection">
                    <div class="template-option">
                        <input type="radio" id="template-web" name="emailTemplate" value="web" required>
                        <label for="template-web" class="template-label">
                            <div class="template-preview">
                                <h3>🌐 Web Template</h3>
                                <p><strong>Subject:</strong> [NAVER Vietnam AI Hackathon 2025] Preliminary Assignment Released</p>
                                <p><strong>Content:</strong> React/React Native To-Do App assignment for Web track</p>
                                <p><strong>Target:</strong> Applicants before September 8</p>
                            </div>
                        </label>
                    </div>
                    
                    <div class="template-option">
                        <input type="radio" id="template-mobile" name="emailTemplate" value="mobile" required>
                        <label for="template-mobile" class="template-label">
                            <div class="template-preview">
                                <h3>📱 Mobile Template</h3>
                                <p><strong>Subject:</strong> [NAVER Vietnam AI Hackathon 2025] Preliminary Assignment Released</p>
                                <p><strong>Content:</strong> Kotlin/Java To-Do App assignment for Mobile track</p>
                                <p><strong>Target:</strong> Applicants before September 8</p>
                            </div>
                        </label>
                    </div>
                    
                    <div class="template-option">
                        <input type="radio" id="template-web-mobile" name="emailTemplate" value="web_mobile" required>
                        <label for="template-web-mobile" class="template-label">
                            <div class="template-preview">
                                <h3>🌐📱 Web & Mobile Template</h3>
                                <p><strong>Subject:</strong> [NAVER Vietnam] Your Hackathon Registration is Confirmed: Preliminary Assignment Inside</p>
                                <p><strong>Content:</strong> Both Web and Mobile tracks with Discord invitation</p>
                                <p><strong>Target:</strong> Applicants after September 8</p>
                            </div>
                        </label>
                    </div>
                </div>
            </div>
            
            <!-- Control Section -->
            <div class="card control-section">
                <h2>Email Control</h2>
                <div class="control-buttons">
                    <button id="startBtn" class="btn btn-success" onclick="startSending()" disabled>
                        Start Sending
                    </button>
                    <button id="stopBtn" class="btn btn-danger" onclick="stopSending()" disabled>
                        Stop Sending
                    </button>
                    <button id="refreshBtn" class="btn btn-primary" onclick="refreshStatus()">
                        Refresh
                    </button>
                    <button onclick="resetStatus()" class="btn btn-secondary" style="padding: 5px 10px; font-size: 12px;">
                        Reset
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Status Section -->
        <div class="card status-section">
            <h2>Sending Status</h2>
            
            <div class="status-grid">
                <div class="status-item">
                    <h3 id="totalEmails">0</h3>
                    <p>Total Emails</p>
                </div>
                <div class="status-item">
                    <h3 id="sentEmails">0</h3>
                    <p>Sent Successfully</p>
                </div>
                <div class="status-item">
                    <h3 id="failedEmails">0</h3>
                    <p>Failed</p>
                </div>
                <div class="status-item">
                    <h3 id="currentBatch">0</h3>
                    <p>Current Batch</p>
                </div>
            </div>
            
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            
            <div id="statusInfo">
                <p><strong>Status:</strong> <span id="statusText">Ready</span></p>
                <p><strong>Template:</strong> <span id="currentTemplate">-</span></p>
                <p><strong>Start Time:</strong> <span id="startTime">-</span></p>
                <p><strong>End Time:</strong> <span id="endTime">-</span></p>
                <p><strong>Last Processed:</strong> <span id="lastProcessed">-</span></p>
            </div>
        </div>
        
        <!-- Logs Section -->
        <div class="logs-section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3>Real-time Logs</h3>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span id="connectionStatus" style="font-size: 12px; padding: 2px 6px; border-radius: 3px; background: #27ae60; color: white;">
                        Connected
                    </span>
                    <button onclick="refreshStatus()" class="btn btn-secondary" style="padding: 5px 10px; font-size: 12px;">
                        Refresh
                    </button>
                    <button onclick="clearLogs()" class="btn btn-warning" style="padding: 5px 10px; font-size: 12px;">
                        Clear
                    </button>
                </div>
            </div>
            <div id="logsContainer" class="logs-container">
                <div class="log-entry info">System ready. Upload a CSV file to begin.</div>
            </div>
        </div>
    </div>
    
    <script>
        let statusInterval;
        
        // File input change handler
        document.getElementById('csvFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            const fileName = file?.name || 'No file selected';
            document.getElementById('fileName').textContent = fileName;
            updateStartButtonState();
        });
        
        // Template selection handler
        document.querySelectorAll('input[name="emailTemplate"]').forEach(radio => {
            radio.addEventListener('change', function() {
                updateStartButtonState();
            });
        });
        
        // Function to update start button state
        function updateStartButtonState() {
            const csvFile = document.getElementById('csvFile').files[0];
            const templateSelected = document.querySelector('input[name="emailTemplate"]:checked');
            const startBtn = document.getElementById('startBtn');
            const fileName = document.getElementById('fileName').textContent;
            
            // Check if file is uploaded (either by file input or by successful upload)
            const fileUploaded = csvFile || fileName.includes('successfully');
            
            if (fileUploaded && templateSelected) {
                startBtn.disabled = false;
                startBtn.textContent = 'Start Sending';
            } else {
                startBtn.disabled = true;
                if (!fileUploaded && !templateSelected) {
                    startBtn.textContent = 'Upload CSV & Select Template';
                } else if (!fileUploaded) {
                    startBtn.textContent = '📁 Upload CSV File';
                } else if (!templateSelected) {
                    startBtn.textContent = '📧 Select Template';
                }
            }
        }
        
        // Form submission handler
        document.getElementById('uploadForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const uploadBtn = document.getElementById('uploadBtn');
            const originalText = uploadBtn.textContent;
            
            uploadBtn.disabled = true;
            uploadBtn.textContent = 'Uploading...';
            
            fetch('/upload', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert(data.message, 'success');
                    document.getElementById('fileName').textContent = 'File uploaded successfully!';
                    updateStartButtonState(); // Update button state after upload
                } else {
                    showAlert(data.message, 'error');
                }
            })
            .catch(error => {
                showAlert('Error uploading file: ' + error, 'error');
            })
            .finally(() => {
                uploadBtn.disabled = false;
                uploadBtn.textContent = originalText;
            });
        });
        
        // Start email sending
        function startSending() {
            const selectedTemplate = document.querySelector('input[name="emailTemplate"]:checked');
            if (!selectedTemplate) {
                showAlert('Please select an email template first!', 'error');
                return;
            }
            
            const requestData = {
                template: selectedTemplate.value
            };
            
            fetch('/start_sending', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('Email sending started!', 'success');
                    document.getElementById('startBtn').disabled = true;
                    document.getElementById('stopBtn').disabled = false;
                    startStatusUpdates();
                } else {
                    showAlert(data.message, 'error');
                }
            })
            .catch(error => {
                showAlert('Error starting email sending: ' + error, 'error');
            });
        }
        
        // Stop email sending
        function stopSending() {
            fetch('/stop_sending', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('Email sending stopped!', 'info');
                    document.getElementById('startBtn').disabled = false;
                    document.getElementById('stopBtn').disabled = true;
                    stopStatusUpdates();
                } else {
                    showAlert(data.message, 'error');
                }
            })
            .catch(error => {
                showAlert('Error stopping email sending: ' + error, 'error');
            });
        }
        
        // Refresh status
        function refreshStatus() {
            updateStatus();
            updateLogs();
        }
        
        // Start status updates
        function startStatusUpdates() {
            statusInterval = setInterval(() => {
                updateStatus();
                updateLogs();
            }, 2000); // Increased to 2 seconds for stability
        }
        
        // Stop status updates
        function stopStatusUpdates() {
            if (statusInterval) {
                clearInterval(statusInterval);
                statusInterval = null;
            }
        }
        
        // Update status with persistent display
        let lastStatusData = null;
        function updateStatus() {
            fetch('/status')
            .then(response => response.json())
            .then(data => {
                // Only update if there are actual changes
                const hasChanges = !lastStatusData || 
                    lastStatusData.total_emails !== data.total_emails ||
                    lastStatusData.sent_emails !== data.sent_emails ||
                    lastStatusData.failed_emails !== data.failed_emails ||
                    lastStatusData.current_batch !== data.current_batch ||
                    lastStatusData.is_running !== data.is_running ||
                    lastStatusData.start_time !== data.start_time ||
                    lastStatusData.end_time !== data.end_time;
                
                if (!hasChanges && lastStatusData) {
                    return; // No changes, skip update
                }
                
                lastStatusData = data;
                
                // Update basic stats
                document.getElementById('totalEmails').textContent = data.total_emails || 0;
                document.getElementById('sentEmails').textContent = data.sent_emails || 0;
                document.getElementById('failedEmails').textContent = data.failed_emails || 0;
                document.getElementById('currentBatch').textContent = data.current_batch || 0;
                
                // Update progress bar with smooth animation
                const total = data.total_emails || 0;
                const sent = data.sent_emails || 0;
                const failed = data.failed_emails || 0;
                const progress = total > 0 ? (sent / total) * 100 : 0;
                
                // Smooth progress bar animation
                const progressFill = document.getElementById('progressFill');
                const currentWidth = parseFloat(progressFill.style.width) || 0;
                if (Math.abs(currentWidth - progress) > 0.1) {
                    progressFill.style.transition = 'width 0.5s ease-in-out';
                    progressFill.style.width = progress + '%';
                }
                
                // Update progress text
                const progressText = total > 0 ? `${sent}/${total} (${progress.toFixed(1)}%)` : '0/0 (0%)';
                progressFill.setAttribute('title', `Sent: ${sent}, Failed: ${failed}, Total: ${total}`);
                
                // Update status text with better states
                let statusText = 'Ready';
                let statusClass = 'status-ready';
                
                if (data.is_running) {
                    statusText = 'Sending...';
                    statusClass = 'status-sending';
                    document.getElementById('startBtn').disabled = true;
                    document.getElementById('stopBtn').disabled = false;
                } else if (data.sent_emails > 0) {
                    if (data.failed_emails > 0) {
                        statusText = `Completed (${data.failed_emails} failed)`;
                        statusClass = 'status-completed-with-errors';
                    } else {
                        statusText = 'Completed Successfully';
                        statusClass = 'status-completed';
                    }
                    document.getElementById('startBtn').disabled = false;
                    document.getElementById('stopBtn').disabled = true;
                } else {
                    document.getElementById('startBtn').disabled = false;
                    document.getElementById('stopBtn').disabled = true;
                }
                
                const statusElement = document.getElementById('statusText');
                statusElement.textContent = statusText;
                statusElement.className = statusClass;
                
                // Update times (only if they exist)
                if (data.start_time) {
                    document.getElementById('startTime').textContent = new Date(data.start_time).toLocaleString();
                }
                if (data.end_time) {
                    document.getElementById('endTime').textContent = new Date(data.end_time).toLocaleString();
                }
                
                // Update template info
                const selectedTemplate = document.querySelector('input[name="emailTemplate"]:checked');
                document.getElementById('currentTemplate').textContent = selectedTemplate ? selectedTemplate.value : '-';
                
                // Update last processed info with better formatting
                if (data.logs && data.logs.length > 0) {
                    const lastLog = data.logs[data.logs.length - 1];
                    let processedText = lastLog.message;
                    
                    // Format the message better
                    if (lastLog.message.includes('Processing email')) {
                        processedText = `📧 ${lastLog.message}`;
                    } else if (lastLog.message.includes('Email sent successfully')) {
                        processedText = `✅ ${lastLog.message}`;
                    } else if (lastLog.message.includes('Failed to send')) {
                        processedText = `❌ ${lastLog.message}`;
                    } else if (lastLog.message.includes('Batch')) {
                        processedText = `📦 ${lastLog.message}`;
                    }
                    
                    document.getElementById('lastProcessed').textContent = processedText;
                } else {
                    document.getElementById('lastProcessed').textContent = '-';
                }
                
                // Update start button state
                updateStartButtonState();
            })
            .catch(error => {
                console.error('Error updating status:', error);
            });
        }
        
        // Update logs with persistent display
        let lastLogCount = 0;
        let displayedLogs = new Set(); // Track displayed logs by timestamp+message
        let isUserScrolled = false;
        
        function updateLogs() {
            const connectionStatus = document.getElementById('connectionStatus');
            const logsContainer = document.getElementById('logsContainer');
            
            fetch('/logs?' + new Date().getTime(), {
                method: 'GET',
                headers: {
                    'Cache-Control': 'no-cache',
                    'Pragma': 'no-cache'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                // Update connection status
                connectionStatus.textContent = '● Connected';
                connectionStatus.style.background = '#27ae60';
                
                // Check if there are new logs
                const currentLogCount = (data.logs || []).length + (data.errors || []).length;
                if (currentLogCount === lastLogCount && currentLogCount > 0) {
                    return; // No new logs, skip update
                }
                lastLogCount = currentLogCount;
                
                // Get all logs
                const allLogs = [...(data.logs || []), ...(data.errors || [])];
                allLogs.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp)); // Sort by time ascending
                
                if (allLogs.length > 0) {
                    // Check if user has scrolled up (not at bottom)
                    const isAtBottom = logsContainer.scrollTop + logsContainer.clientHeight >= logsContainer.scrollHeight - 10;
                    
                    // Add only new logs
                    let newLogsAdded = 0;
                    allLogs.forEach(log => {
                        const logKey = `${log.timestamp}-${log.message}`;
                        if (!displayedLogs.has(logKey)) {
                            const logEntry = document.createElement('div');
                            logEntry.className = `log-entry ${log.type}`;
                            logEntry.setAttribute('data-log-key', logKey);
                            
                            const timestamp = new Date(log.timestamp).toLocaleTimeString();
                            const message = log.message || 'No message';
                            
                            logEntry.innerHTML = `<span style="color: #888;">[${timestamp}]</span> ${message}`;
                            logsContainer.appendChild(logEntry);
                            
                            displayedLogs.add(logKey);
                            newLogsAdded++;
                        }
                    });
                    
                    // Keep only last 50 logs to prevent memory issues
                    if (displayedLogs.size > 50) {
                        const logEntries = logsContainer.querySelectorAll('.log-entry');
                        const toRemove = logEntries.length - 50;
                        for (let i = 0; i < toRemove; i++) {
                            const logKey = logEntries[i].getAttribute('data-log-key');
                            displayedLogs.delete(logKey);
                            logEntries[i].remove();
                        }
                    }
                    
                    // Auto-scroll to bottom only if user was at bottom or new logs were added
                    if (isAtBottom || newLogsAdded > 0) {
                        logsContainer.scrollTop = logsContainer.scrollHeight;
                    }
                } else {
                    // Only show "no logs" message if container is empty
                    if (logsContainer.children.length === 0) {
                        const logEntry = document.createElement('div');
                        logEntry.className = 'log-entry info';
                        logEntry.innerHTML = 'No logs available yet. Upload a CSV file and start sending emails to see logs here.';
                        logsContainer.appendChild(logEntry);
                    }
                }
            })
            .catch(error => {
                console.error('Error updating logs:', error);
                
                // Update connection status to error
                connectionStatus.textContent = '● Error';
                connectionStatus.style.background = '#e74c3c';
                
                // Only show error if container is empty
                if (logsContainer.children.length === 0) {
                    logsContainer.innerHTML = '<div class="log-entry error">Error loading logs: ' + error.message + '</div>';
                }
            });
        }
        
        // Clear logs function
        function clearLogs() {
            const logsContainer = document.getElementById('logsContainer');
            logsContainer.innerHTML = '';
            displayedLogs.clear();
            lastLogCount = 0;
            
            // Add initial message
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry info';
            logEntry.innerHTML = 'Logs cleared. Upload a CSV file and start sending emails to see logs here.';
            logsContainer.appendChild(logEntry);
            
            showAlert('Logs cleared successfully', 'info');
        }
        
        // Reset status function
        function resetStatus() {
            // Reset status data
            lastStatusData = null;
            
            // Reset UI elements
            document.getElementById('totalEmails').textContent = '0';
            document.getElementById('sentEmails').textContent = '0';
            document.getElementById('failedEmails').textContent = '0';
            document.getElementById('currentBatch').textContent = '0';
            
            // Reset progress bar
            const progressFill = document.getElementById('progressFill');
            progressFill.style.width = '0%';
            progressFill.style.transition = 'none';
            progressFill.setAttribute('title', 'Sent: 0, Failed: 0, Total: 0');
            
            // Reset status text
            const statusElement = document.getElementById('statusText');
            statusElement.textContent = 'Ready';
            statusElement.className = 'status-ready';
            
            // Reset times
            document.getElementById('startTime').textContent = '-';
            document.getElementById('endTime').textContent = '-';
            document.getElementById('currentTemplate').textContent = '-';
            document.getElementById('lastProcessed').textContent = '-';
            
            // Reset buttons
            document.getElementById('startBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
            
            // Update button state
            updateStartButtonState();
            
            showAlert('Status reset successfully', 'info');
        }
        
        // Track user scroll to determine if we should auto-scroll
        document.addEventListener('DOMContentLoaded', function() {
            const logsContainer = document.getElementById('logsContainer');
            logsContainer.addEventListener('scroll', function() {
                const isAtBottom = this.scrollTop + this.clientHeight >= this.scrollHeight - 10;
                isUserScrolled = !isAtBottom;
            });
        });
        
        
        // Show alert
        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            
            const container = document.querySelector('.container');
            container.insertBefore(alertDiv, container.firstChild);
            
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            updateStatus();
            updateLogs();
            updateStartButtonState();
            
            // Start periodic updates only if not already running
            if (!statusInterval) {
                setInterval(() => {
                    updateStatus();
                    updateLogs();
                }, 3000); // 3 seconds for stability
            }
        });
    </script>
</body>
</html>
